# Next.js 静的アセット消失防止ワークフロー（R2）

## 背景
- Next.jsは `/_next/static/*` をハッシュ付きで出力する
- 旧HTML/旧CSSが端末に残っている間に、参照先アセットが削除されると404が発生する
- 404が大量に発生すると、ログ/CPUに悪影響が出る

## 目的
- 静的ファイルはキャッシュしたまま維持する
- 旧キャッシュが参照するアセットが消えないようにする
- デプロイ時に「消えてしまう参照」を事前に検知して止める

## ワークフロー（概要）
1. **ビルド後に成果物をスキャン**
   - `/_next/static/**/*.css|js` を読み、参照アセット一覧を抽出
2. **R2の前回スナップショットと比較**
   - 前回参照されていたアセットが欠けていれば **デプロイ中断**
3. **デプロイ成功後に新スナップショットを保存**
   - 次回の比較用にR2へ保存

## 使うスクリプト
- `scripts/check-next-static-assets.ts`
  - `check` : R2のスナップショットと比較
  - `--save`: 今回の参照一覧をR2に保存

## 実際の流れ（deployに自動組み込み）
```
cf:build
→ check (R2から取得して比較)
→ deploy
→ save (R2へ保存)
```

## 注意
- 初回だけ `--save` が必要（スナップショットが無いとcheckは失敗）
- 参照範囲は **CSS + JS（標準）**

## 参照先
- `docs/incidents/2026-02-04-next-static-cache-404.md`

# Next.js 静的アセット消失防止ワークフロー（R2）

## 背景
- Next.jsは `/_next/static/*` をハッシュ付きで出力する
- 旧HTML/旧CSSが端末に残っている間に、参照先アセットが削除されると404が発生する
- 404が大量に発生すると、ログ/CPUに悪影響が出る

## 目的
- 静的ファイルはキャッシュしたまま維持する
- 旧キャッシュが参照するアセットが消えないようにする
- デプロイ時に「消えてしまう参照」を事前に検知して止める

## ワークフロー（概要）
1. **ビルド後に成果物をスキャン**
   - `/_next/static/**/*.css|js` を読み、参照アセット一覧を抽出
2. **R2の前回スナップショットと比較**
   - 前回参照されていたアセットが欠けていれば **デプロイ中断**
3. **デプロイ成功後に新スナップショットを保存**
   - 次回の比較用にR2へ保存

## 使うスクリプト
- `scripts/check-save-next-static-assets.ts`
  - 1回の実行で **比較 + R2保存** まで行う

## 実際の流れ（ビルド後に実行）
```
cf:build
→ check+save（R2から取得して比較 → OKならR2保存）
→ deploy（必要な場合のみ）
```

## 注意
- ローカルのスナップショットは一時ファイルに保存し、実行終了後に自動削除される（リポジトリに残らない）
- 初回はR2キーが存在しなくても、**自動でベースラインを作成してアップロード**される
- 参照範囲は **CSS + JS（標準）**

## 参照先
- `docs/incidents/2026-02-04-next-static-cache-404.md`
